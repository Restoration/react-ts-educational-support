# React セキュリティ
こちらのサイトを参考にセキュリティチェックをすると良い  
実務であれば、チェックシート的なものを用意して各項目を確認するなどする  

## 見ておくべき情報源

IPA  
- https://www.ipa.go.jp/

2025 年の大脅威  
- https://www.ipa.go.jp/security/10threats/10threats2025.html

安全なウェブサイトの作り方  
- https://www.ipa.go.jp/security/vuln/websecurity/about.html

---

React 自体は UI ライブラリであり、サーバーサイドのセキュリティ全般（認証、認可、データ検証など）については直接の責任を持ちませんが、フロントエンドの実装においても注意すべきセキュリティの観点があります。以下、React に関連する主要なセキュリティ対策と注意点をいくつか紹介します。  

---

## 1. クロスサイトスクリプティング（XSS）対策

- **自動エスケープ**  
  React は JSX 内で埋め込む値を自動的にエスケープしてくれるため、通常の記述では XSS 攻撃のリスクは低減されます。  
  基本的に{}で囲ったものはクロスサイトスクリプティングから回避してくれる。  
  これは React 内部の仕様で埋め込まれた値をレンダリングする前にエスケープしてくれるからです。  
  悪質なスクリプトが入っていてもレンダー前には文字列となる。  
  例：

  ```jsx
  const userInput = '<script>alert("XSS")</script>';
  // JSX内で表示すると自動的にエスケープされる
  <div>{userInput}</div>;
  ```

  上記のことから React を利用していると基本的に XSS 攻撃を心配はしなくてもよいが`dangerouslySetInnerHTML`を利用する際は注意が必要になる
  dangerouslySetInnerHTML は、React で生の HTML を要素に挿入するためのプロパティです。通常の JSX では {} を使って変数や値を挿入できますが、HTML タグをそのまま描画するには dangerouslySetInnerHTML を使う必要があります。  

- **`dangerouslySetInnerHTML`の利用**  
  HTML 文字列を直接 DOM に挿入する必要がある場合、`dangerouslySetInnerHTML`を使用しますが、この方法はエスケープが行われないため、信頼できないデータを直接挿入すると XSS 攻撃のリスクがあります。  
  ```jsx
  <div dangerouslySetInnerHTML={{ __html: trustedHTML }} />
  ```
  ※ `trustedHTML` は信頼できる、または十分にサニタイズされた内容であることを確認してください。

利用されるタイミング

1. 外部から取得した HTML をそのまま表示したいとき  
   CMS や API から取得したデータが HTML の形式で提供される場合。  
   Markdown などを HTML に変換した後に表示したい場合。  
2. HTML 文字列として保存されたコンテンツを描画するとき  
   例えば、ユーザーがリッチテキストエディタで作成したデータを表示するとき。  
3. 埋め込みコンテンツを扱うとき  
   例えば、広告タグや外部ウィジェットを直接挿入するとき。  
   （Google のアナリティクスのスクリプトを埋め込む時などに利用されていた。現在は npm パッケージを利用して埋め込むことが増えた）  
  
注意点  
XSS（クロスサイトスクリプティング）に注意
  
外部からの HTML をそのまま挿入すると、悪意のあるスクリプトが実行される可能性があるため、サニタイズ処理（DOMPurify など）を施すべき。
対策: DOMPurify を使う  

```tsx
import DOMPurify from "dompurify";

const SafeHtmlContent = ({ content }: { content: string }) => {
  const sanitizedContent = DOMPurify.sanitize(content);
  return <div dangerouslySetInnerHTML={{ __html: sanitizedContent }} />;
};
```

---

## 2. コンポーネントの状態管理とデータの流れ

- **Props と State の扱い**  
  コンポーネント間でデータを受け渡す際、ユーザー入力や外部ソースからのデータは必ずサニタイズや検証を行い、予期しない動作を防ぎます。  

- **不正な値の注入防止**  
  アプリケーションが外部からデータを取得する場合、取得したデータをそのまま表示する前に検証し、想定外のスクリプトが混入していないか確認することが重要です。  

React は **仮想 DOM（Virtual DOM）** を利用して効率的に UI を更新します。  
しかし、`document.querySelector` や `getElementById` などで **直接 DOM を操作すると、仮想 DOM の管理と競合する** 可能性があります。  

**直接 DOM を変更する例**

```tsx
useEffect(() => {
  document.getElementById("myDiv")!.innerText = "変更されたテキスト";
}, []);
```

このようにすると、React が仮想 DOM を更新した際に、変更が上書きされる可能性があります。
そのためセオリー通り React の state を使う。    

```tsx
const [text, setText] = useState("初期テキスト");

return <div id="myDiv">{text}</div>;
```
---

## 3. サードパーティライブラリの利用

- **信頼性の確認**  
  React アプリケーションでは、多くのサードパーティコンポーネントやライブラリが利用されます。これらのライブラリに脆弱性が含まれていると、アプリケーション全体に影響を与える可能性があるため、利用前にライブラリの評判、更新状況、既知のセキュリティ問題などを確認してください。  

- **依存関係の定期的な更新**    
  npm や yarn を使用している場合、依存パッケージの更新情報や脆弱性アラートを定期的に確認し、必要に応じてアップデートを実施しましょう。  

ポイントとして、ライブラリは便利ではあるが、後々更新作業で時間がかかるケースがあるのでライブラリに頼らずに自前で用意したほうがよい。  
appのサンプルアプリではnpmインストールをするとwarningが出るので修正してみましょう。

```
npm warn deprecated @types/dompurify@3.2.0: This is a stub types definition. dompurify provides its own type definitions, so you do not need this installed.
```

---

## 4. 認証と認可の実装

- **フロントエンドでの注意点**  
  React はクライアントサイドで動作するため、セキュリティの本質はサーバー側に依存します。  
  フロントエンドでは、認証情報（JWT トークンなど）の管理において、ブラウザのストレージ（localStorage、sessionStorage など）に保存する場合、そのリスク（XSS など）を理解し、適切なセキュリティ対策を講じる必要があります。  

- **API との連携**  
  認証や認可に関しては、フロントエンドだけでなくサーバー側でも厳密なチェックを行い、不正なリクエストを防ぐ設計が必要です。  

---

## 5. 開発環境のセキュリティ

- **環境変数の管理**  
  API キーや秘密情報をクライアントサイドに埋め込まないように注意しましょう。これらの情報はサーバー側で管理し、必要な場合は安全な方法でクライアントに提供するようにします。  
  基本的には.env ファイルで管理をおこなう。また.env ファイルは Git 上にコミットしてしまわないように注意する。  
  実際に攻撃者は`http://example.com/.env`等の URL を直叩きしてくることもある。  

- **HTTPS の利用**  
  通信経路の安全性を確保するため、開発・本番環境ともに HTTPS を利用することが推奨されます。  

---

## 6. データ漏洩

- **フロントで取り扱うデータの管理**  
  API からデータを受け取り、State などにセットする。State も結果的には JS なのでフロント側で全て見えてしまう。  
  デプロイするときは console.log なども削除する。  
  React の State なども見ようと思えば見えてしまうため、フロントでは漏れてはいけない情報は取り扱わないようにデータの精査をする。  
  （そもそも API からそういったデータを出さないようにしてもらう）  

---

## 7. その他のベストプラクティス

- **Content Security Policy (CSP) の設定**  
  サーバー側で CSP を設定することで、悪意のあるスクリプトの実行を防ぐことができます。  
  (React ではホスティング先などで CSP 設定をします、対して Next.js は CSP の設定機能を持っています。）  

- **セキュリティツールの活用**  
  静的解析ツールや依存関係の脆弱性スキャナ（例: npm audit, Snyk など）を利用して、セキュリティ上の問題を早期に発見・対策することが重要です。  

```
# プロジェクトの依存関係に含まれるセキュリティ脆弱性をスキャンし、修正が必要な箇所をレポート
npm audit
```

※ `npm audit fix` は、Node.js のパッケージマネージャーである npm のコマンドの一つで、依存関係のセキュリティ脆弱性を自動的に修正する ために使用されます。  


- https://snyk.io/jp/

---

## まとめ

ここまでが CSR で実装するときの注意点。SSR で実装する際はサーバーでデータを返す際の考慮をしなければならないため、セキュリティの意識する部分が違ってきます。  
React のフロントエンド開発においてセキュリティの脆弱性を生んでしまうポイントは認証機能の実装ミス。  
例えば、表示してはいけない情報をフロントで持ってしまったりなど。  
ある程度はフレームワーク側でセキュリティの担保はしてくれるのでフロントエンド開発で気をつけるべきは認証の実装になります。  

---
